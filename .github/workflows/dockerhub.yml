name: Build and Push Dockerfile-rpi

on:
  push: 
    branches: [ master, issue-83-fix_image_publishing ]

jobs:
  login-to-dockerhub:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Login to DockerHub
      env:
        DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
        DOCKERHUB_PASSWD: ${{ secrets.DOCKERHUB_PASSWD }}
      run: |
        docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASSWD

    - name: Build the Docker image  
    - uses: aevea/action-kaniko@v0.6.0
      with:
        contest: Dockerfile-rpi
        image: mistagreen/pinp
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWD }}
        cache: true
        cache_registry: mistagreen/cache
        tag: $GITHUB_SHA 
      
    - name: Push the Docker image
      run: docker push mistagreen/pinp
    